{% extends "base.html" %}

{% block title %}Bus Map - Student Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="fas fa-map-marked-alt me-2"></i>Live Bus Tracking</h2>
        <p class="text-muted mb-0">Bus {{ bus.bus_number }} - Driver: {{ bus.driver_name }}</p>
    </div>
    <div>
        <button type="button" class="btn btn-outline-success me-2" id="centerOnBus">
            <i class="fas fa-bus me-2"></i>Center on Bus
        </button>
        <button type="button" class="btn btn-outline-info" id="centerOnStation">
            <i class="fas fa-map-marker-alt me-2"></i>My Station
        </button>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-satellite-dish me-2"></i>Real-time Location
                        <span class="badge bg-success ms-2" id="connectionStatus">Connected</span>
                    </h5>
                    <div>
                        <small class="text-muted">Last update: <span id="lastUpdate">-</span></small>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="map" style="height: 500px; width: 100%;"></div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-info-circle me-2"></i>Bus Information
                </h5>
                <div class="row">
                    <div class="col-6">
                        <strong>Bus Number:</strong><br>
                        <span class="h6 text-primary">{{ bus.bus_number }}</span>
                    </div>
                    <div class="col-6">
                        <strong>Driver:</strong><br>
                        {{ bus.driver_name }}<br>
                        <small class="text-muted">{{ bus.driver_phone }}</small>
                    </div>
                </div>
                <hr>
                <div class="mb-2">
                    <strong>Your Pickup Station:</strong><br>
                    <i class="fas fa-map-marker-alt text-success me-1"></i>
                    {{ pickup_station.station_name }}
                </div>
                <div class="row">
                    <div class="col-6">
                        <small class="text-muted">Current Speed:</small><br>
                        <span id="busSpeed">- km/h</span>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">ETA to Your Station:</small><br>
                        <span id="etaToStation">Calculating...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-route me-2"></i>Route Stations
                </h5>
                <div id="stationsList" class="station-list" style="max-height: 200px; overflow-y: auto;">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin"></i> Loading stations...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
class StudentMapTracker {
    constructor() {
        this.map = null;
        this.busMarker = null;
        this.stationMarkers = [];
        this.routePolyline = null;
        this.updateInterval = null;
        this.previousPosition = null;
        this.UPDATE_INTERVAL = 5000; // 5 seconds for real-time feel
        
        this.init();
    }
    
    init() {
        this.initMap();
        this.loadStations();
        this.startRealTimeUpdates();
        this.setupEventListeners();
    }
    
    initMap() {
        // Initialize map centered on a default location
        this.map = L.map('map').setView([40.7128, -74.0060], 13);
        
        // Add tile layer (using OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(this.map);
        
        // Add map controls
        this.map.zoomControl.setPosition('topright');
    }
    
    async loadStations() {
        try {
            const response = await fetch('/api/map/student/route-stations');
            if (response.ok) {
                const stations = await response.json();
                this.displayStations(stations);
            }
        } catch (error) {
            console.error('Error loading stations:', error);
        }
    }
    
    displayStations(stations) {
        // Clear existing station markers
        this.stationMarkers.forEach(marker => this.map.removeLayer(marker));
        this.stationMarkers = [];
        
        const stationCoords = [];
        let stationsHTML = '';
        
        stations.forEach((station, index) => {
            // Create station marker
            const isPickupStation = station.is_pickup_station;
            const icon = isPickupStation ? 
                L.divIcon({
                    html: `<div style="background-color: #28a745; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">${station.order}</div>`,
                    className: 'custom-marker',
                    iconSize: [30, 30]
                }) :
                L.divIcon({
                    html: `<div style="background-color: #6c757d; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 12px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">${station.order}</div>`,
                    className: 'custom-marker',
                    iconSize: [25, 25]
                });
            
            const marker = L.marker([station.latitude, station.longitude], { icon })
                .addTo(this.map)
                .bindPopup(`<strong>${station.station_name}</strong><br>Station ${station.order}${isPickupStation ? '<br><span style="color: #28a745;"><strong>Your Pickup Station</strong></span>' : ''}`);
            
            this.stationMarkers.push(marker);
            stationCoords.push([station.latitude, station.longitude]);
            
            // Add to stations list
            stationsHTML += `
                <div class="d-flex align-items-center mb-2 p-2 ${isPickupStation ? 'bg-success bg-opacity-10 border border-success rounded' : ''}">
                    <div class="me-3">
                        <span class="badge ${isPickupStation ? 'bg-success' : 'bg-secondary'}">${station.order}</span>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-bold">${station.station_name}</div>
                        ${isPickupStation ? '<small class="text-success">Your Pickup Station</small>' : ''}
                    </div>
                </div>
            `;
        });
        
        document.getElementById('stationsList').innerHTML = stationsHTML;
        
        // Draw route line if we have stations
        if (stationCoords.length > 1) {
            if (this.routePolyline) {
                this.map.removeLayer(this.routePolyline);
            }
            this.routePolyline = L.polyline(stationCoords, { 
                color: '#007bff', 
                weight: 3, 
                opacity: 0.7,
                dashArray: '10, 5'
            }).addTo(this.map);
        }
    }
    
    async updateBusLocation() {
        try {
            const response = await fetch('/api/map/student/bus-location');
            if (response.ok) {
                const data = await response.json();
                this.displayBusLocation(data);
                this.updateConnectionStatus(true);
                this.updateLastUpdateTime();
                
                // Calculate speed if we have previous position
                if (this.previousPosition) {
                    const speed = this.calculateSpeed(this.previousPosition, data);
                    document.getElementById('busSpeed').textContent = speed.toFixed(1) + ' km/h';
                }
                this.previousPosition = data;
                
            } else {
                throw new Error('Failed to fetch location');
            }
        } catch (error) {
            console.error('Error updating location:', error);
            this.updateConnectionStatus(false);
        }
    }
    
    displayBusLocation(locationData) {
        const { latitude, longitude, bus_number, driver_name } = locationData;
        
        // Create or update bus marker
        if (this.busMarker) {
            this.busMarker.setLatLng([latitude, longitude]);
        } else {
            const busIcon = L.divIcon({
                html: `<div style="background-color: #dc3545; color: white; border-radius: 10px; padding: 5px 10px; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"><i class="fas fa-bus"></i> ${bus_number}</div>`,
                className: 'custom-bus-marker',
                iconSize: [80, 30]
            });
            
            this.busMarker = L.marker([latitude, longitude], { icon: busIcon })
                .addTo(this.map)
                .bindPopup(`<strong>Bus ${bus_number}</strong><br>Driver: ${driver_name}<br>Location updated: ${new Date().toLocaleTimeString()}`);
        }
        
        // Update popup content
        this.busMarker.getPopup().setContent(`<strong>Bus ${bus_number}</strong><br>Driver: ${driver_name}<br>Location updated: ${new Date().toLocaleTimeString()}`);
    }
    
    calculateSpeed(prevPos, currPos) {
        const prevTime = new Date(prevPos.timestamp);
        const currTime = new Date(currPos.timestamp);
        const timeDiff = (currTime - prevTime) / 1000 / 3600; // hours
        
        if (timeDiff === 0) return 0;
        
        const distance = this.getDistance(
            prevPos.latitude, prevPos.longitude,
            currPos.latitude, currPos.longitude
        );
        
        return distance / timeDiff;
    }
    
    getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Earth's radius in km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }
    
    updateConnectionStatus(connected) {
        const statusElement = document.getElementById('connectionStatus');
        if (connected) {
            statusElement.className = 'badge bg-success ms-2';
            statusElement.textContent = 'Connected';
        } else {
            statusElement.className = 'badge bg-danger ms-2';
            statusElement.textContent = 'Disconnected';
        }
    }
    
    updateLastUpdateTime() {
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
    }
    
    startRealTimeUpdates() {
        // Initial load
        this.updateBusLocation();
        
        // Set up interval for real-time updates
        this.updateInterval = setInterval(() => {
            this.updateBusLocation();
        }, this.UPDATE_INTERVAL);
    }
    
    setupEventListeners() {
        document.getElementById('centerOnBus').addEventListener('click', () => {
            if (this.busMarker) {
                this.map.setView(this.busMarker.getLatLng(), 15);
                this.busMarker.openPopup();
            }
        });
        
        document.getElementById('centerOnStation').addEventListener('click', () => {
            const pickupStation = this.stationMarkers.find(marker => 
                marker.getPopup().getContent().includes('Your Pickup Station')
            );
            if (pickupStation) {
                this.map.setView(pickupStation.getLatLng(), 15);
                pickupStation.openPopup();
            }
        });
        
        // Handle visibility change to pause/resume updates
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                    this.updateInterval = null;
                }
            } else {
                if (!this.updateInterval) {
                    this.startRealTimeUpdates();
                }
            }
        });
    }
    
    destroy() {
        if (this.updateInterval) {
            clearInterval(this.updateInterval);
        }
    }
}

// Initialize the map tracker when DOM is loaded
let mapTracker;
document.addEventListener('DOMContentLoaded', function() {
    mapTracker = new StudentMapTracker();
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (mapTracker) {
        mapTracker.destroy();
    }
});
</script>
{% endblock %}